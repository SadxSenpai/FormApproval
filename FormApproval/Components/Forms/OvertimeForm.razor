@using Microsoft.AspNetCore.Components.Forms
@inject FormApproval.Services.IFormRepository Repo
@inject FormApproval.Services.ICurrentUser Me
@inject NavigationManager Nav
@inject ILogger<OvertimeForm> Logger

<EditForm Model="@vm"
          OnValidSubmit="@HandleSubmit"
          OnInvalidSubmit="@HandleInvalidSubmit"
          FormName="NewLeaveRequestForm-Overtime">
    <DataAnnotationsValidator />
    <ValidationSummary />

    <style>
        :root {
          --bg: #f7f7fb;
          --card: #ffffff;
          --text: #1f2937;
          --muted: #6b7280;
          --primary: #2563eb;
          --border: #e5e7eb;
          --radius: 12px;
        }
        .fa-container { max-width: 960px; margin: 20px 0; padding: 0 0; }
        .fa-card {
          background: var(--card); border: 1px solid var(--border);
          border-radius: var(--radius); padding: 24px 20px; box-shadow: 0 4px 16px rgb(0 0 0 / 5%);
        }
        .fa-title { margin: 0 0 4px; font-size: 1.3rem; }
        .fa-subtitle { color: var(--muted); margin-bottom: 14px; }
        fieldset {
          border: 1px solid var(--border); border-radius: 10px;
          padding: 16px; margin: 18px 0;
        }
        legend { padding: 0 8px; color: var(--muted); font-size: .95rem; }
        label { display: block; margin: 10px 0 6px; font-weight: 600; }
        .fa-input,
        .fa-textarea,
        .fa-select {
          width: 100%; padding: 10px 12px; border: 1px solid var(--border);
          border-radius: 10px; background: #fff; color: var(--text);
        }
        .fa-textarea { min-height: 110px; resize: vertical; }
        .fa-row { display: grid; grid-template-columns: 1fr; gap: 16px; }
        @@media (min-width: 720px) {
          .fa-row.cols-2 { grid-template-columns: repeat(2, 1fr); }
          .fa-row.cols-3 { grid-template-columns: repeat(3, 1fr); }
        }
        .inline { display: flex; gap: 18px; flex-wrap: wrap; align-items: center; }
        .inline .form-check { display: flex; align-items: center; gap: 8px; }
        .help { color: var(--muted); font-size: .9rem; margin-top: 6px; }
        .actions { display: flex; gap: 10px; margin-top: 14px; }
        .btn-reset {
          appearance: none; border: 1px solid var(--border);
          background: var(--card); color: var(--text); padding: 10px 14px;
          border-radius: 10px; cursor: pointer;
        }
        .btn-primary-like {
          background: var(--primary); color: #fff; border: 1px solid var(--primary);
          padding: 10px 14px; border-radius: 10px; cursor: pointer;
        }
    </style>

    <div class="fa-container">
        <div class="fa-card">
            <h1 class="fa-title">Overtime Reduction / Early Leave</h1>
            <p class="fa-subtitle">Please fill out. Fields with * are required.</p>

            @* Person *@
            <fieldset>
                <legend>Person</legend>
                <div class="fa-row cols-2">
                    <div>
                        <label>Full Name</label>
                        <InputText class="fa-input" @bind-Value="vm.FullName" readonly />
                    </div>
                    <div>
                        <label>Email</label>
                        <InputText class="fa-input" @bind-Value="vm.Email" readonly />
                    </div>
                </div>

                <div class="fa-row cols-2">
                    <div>
                        <label>Department</label>
                        <InputText class="fa-input" @bind-Value="vm.Department" readonly />
                    </div>
                    <div>
                        <label>Date *</label>
                        <InputDate class="fa-input" @bind-Value="vm.Day" />
                    </div>
                </div>
            </fieldset>

            @* Time window *@
            <fieldset>
                <legend>Time window *</legend>
                <div class="fa-row cols-2">
                    <div>
                        <label>Start time *</label>
                        <select class="fa-select" @onchange="OnStartChanged" value="@startValue">
                            <option value="">-- Select --</option>
                            @foreach (var s in Slots)
                            {
                                var val = s.ToString("HH:mm");
                                <option value="@val" selected="@(val == startValue)">@val</option>
                            }
                        </select>
                    </div>
                    <div>
                        <label>End time *</label>
                        <select class="fa-select" @onchange="OnEndChanged" value="@endValue">
                            <option value="">-- Select --</option>
                            @foreach (var s in Slots)
                            {
                                var val = s.ToString("HH:mm");
                                <option value="@val" selected="@(val == endValue)">@val</option>
                            }
                        </select>
                    </div>
                </div>

            @* Visual timeline bar *@
            <div class="mt-2">
                <div class="d-flex justify-content-between small text-muted">
                    <span>@WorkStart.ToString("HH:mm")</span>
                    <span>@WorkEnd.ToString("HH:mm")</span>
                </div>
                <div style="position:relative;height:12px;background:#e9ecef;border-radius:6px;">
                    <div style="position:absolute;left:@LeftPercent%;width:@WidthPercent%;height:100%;background:#0d6efd;border-radius:6px;"></div>
                </div>
            </div>

            @if (TotalMinutes is int m && m > 0)
            {
                <div class="alert alert-info mt-2 py-2">
                    <b>Total:</b> @($"{m} min") (@(Math.Round(m / 60.0, 2)) h)
                </div>
            }
            </fieldset>

            @* Reason *@
            <fieldset>
                <legend>Reason *</legend>
                <InputTextArea class="fa-textarea" @bind-Value="vm.Reason" />
            </fieldset>

            @* Aktionen/Actions *@
            <div class="actions">
                <button class="btn-reset" type="button" @onclick="BackToSelection">Back to selection</button>
                <button class="btn-reset" type="button" @onclick="SaveDraft">Save Draft</button>
                <button class="btn-primary-like" type="submit">Submit</button>
            </div>

            @if (!string.IsNullOrEmpty(dateError))
            {
                <div class="validation-message mt-2">@dateError</div>
            }
        </div>
    </div>
</EditForm>

@code {
    [Parameter] public Guid TemplateId { get; set; }

    private NewVm vm = new();
    private string? dateError;

    private static readonly TimeOnly WorkStart = new(7, 30);
    private static readonly TimeOnly WorkEnd = new(16, 0);
    private readonly List<TimeOnly> Slots = new();

    private string? startValue;
    private string? endValue;

    protected override void OnParametersSet()
    {
        vm.FullName = Me.Name;
        vm.Email = Me.Email;
        vm.Department = Me.Department;

        Slots.Clear();
        for (var t = WorkStart; t <= WorkEnd; t = t.AddMinutes(30))
            Slots.Add(t);

        startValue = vm.StartTime?.ToString("HH:mm");
        endValue = vm.EndTime?.ToString("HH:mm");
    }

    private void OnStartChanged(ChangeEventArgs e)
    {
        startValue = e.Value?.ToString();
        vm.StartTime = ParseSlot(startValue);
        if (vm.EndTime.HasValue && vm.StartTime.HasValue && Compare(vm.EndTime.Value, vm.StartTime.Value) <= 0)
        {
            vm.EndTime = null;
            endValue = null;
        }
        StateHasChanged();
    }

    private void OnEndChanged(ChangeEventArgs e)
    {
        endValue = e.Value?.ToString();
        vm.EndTime = ParseSlot(endValue);
        StateHasChanged();
    }

    private static TimeOnly? ParseSlot(string? v)
        => TimeOnly.TryParse(v, out var t) ? t : null;

    private static int Compare(TimeOnly a, TimeOnly b)
        => TimeSpan.Compare(a.ToTimeSpan(), b.ToTimeSpan());

    private static double MinutesBetween(TimeOnly a, TimeOnly b)
        => (a.ToTimeSpan() - b.ToTimeSpan()).TotalMinutes;

    private double LeftPercent
    {
        get
        {
            if (vm.StartTime is not TimeOnly s) return 0;
            var total = MinutesBetween(WorkEnd, WorkStart);
            var left = Math.Clamp(MinutesBetween(s, WorkStart), 0, total);
            return Math.Round(left / total * 100.0, 2);
        }
    }

    private double WidthPercent
    {
        get
        {
            if (vm.StartTime is not TimeOnly s || vm.EndTime is not TimeOnly e) return 0;
            var total = MinutesBetween(WorkEnd, WorkStart);
            var width = Math.Clamp(MinutesBetween(e, s), 0, total);
            return Math.Round(width / total * 100.0, 2);
        }
    }

    private int? TotalMinutes
    {
        get
        {
            if (vm.StartTime is not TimeOnly s || vm.EndTime is not TimeOnly e) return null;
            var mins = (int)MinutesBetween(e, s);
            return mins > 0 ? mins : null;
        }
    }

    private void BackToSelection()
    {
        Nav.NavigateTo("/new");
    }

    private void SaveDraft()
    {
        var inst = ToInstance();
        Repo.CreateDraft(inst);
        Nav.NavigateTo($"/form/{inst.Id}");
    }

    private void HandleSubmit(EditContext context)
    {
        dateError = null;
        if (!ValidateInputs(out var err))
        {
            dateError = err;
            return;
        }

        var inst = ToInstance();
        inst.Status = FormApproval.Domain.FormStatus.Submitted;
        inst.SubmittedAt = DateTime.UtcNow;
        inst.Audit.Add(new() { Actor = Me.Name, Action = "Submit" });

        Repo.CreateDraft(inst);
        Nav.NavigateTo("/submitted");
    }

    private bool ValidateInputs(out string error)
    {
        error = string.Empty;
        if (!vm.Day.HasValue) { error = "Date is required."; return false; }
        if (!vm.StartTime.HasValue) { error = "Start time is required."; return false; }
        if (!vm.EndTime.HasValue) { error = "End time is required."; return false; }
        if (Compare(vm.EndTime.Value, vm.StartTime.Value) <= 0) { error = "End must be after Start."; return false; }
        if (Compare(vm.StartTime.Value, WorkStart) < 0 || Compare(vm.EndTime.Value, WorkEnd) > 0)
        {
            error = $"Times must be within the workday {WorkStart:HH\\:mm}–{WorkEnd:HH\\:mm}.";
            return false;
        }
        if (string.IsNullOrWhiteSpace(vm.Reason)) { error = "Please provide a reason"; return false; }
        if (TotalMinutes is not int m || m <= 0) { error = "Total must be greater than 0 minutes."; return false; }
        return true;
    }

    private void HandleInvalidSubmit(EditContext editContext)
    {
        var messages = string.Join(" | ", editContext.GetValidationMessages());
        Logger.LogWarning("Overtime OnInvalidSubmit (Template={TemplateId}). Errors: {Errors}",
            TemplateId, string.IsNullOrWhiteSpace(messages) ? "(none)" : messages);
    }

    private FormApproval.Domain.FormInstance ToInstance()
    {
        var answers = new Dictionary<string, string?>();

        answers["FullName"] = vm.FullName;
        answers["Email"] = vm.Email;
        answers["Department"] = vm.Department;
        answers["Reason"] = vm.Reason;

        answers["Date"] = vm.Day?.ToString("yyyy-MM-dd");
        answers["StartTime"] = vm.StartTime?.ToString("HH:mm");
        answers["EndTime"] = vm.EndTime?.ToString("HH:mm");
        answers["TotalHours"] = TotalMinutes is int m ? Math.Round(m / 60.0, 2).ToString("0.##") : null;
        answers["TotalMinutes"] = TotalMinutes?.ToString();

        var inst = new FormApproval.Domain.FormInstance
        {
            TemplateId = TemplateId,
            OwnerUserId = Me.UserId,
            OwnerName = Me.Name,
            OwnerEmail = Me.Email,
            Department = Me.Department,
            Answers = answers
        };
        inst.Audit.Add(new() { Actor = Me.Name, Action = "Create" });
        return inst;
    }

    public class NewVm
    {
        public string? FullName { get; set; }
        public string? Email { get; set; }
        public string? Department { get; set; }
        public DateTime? Day { get; set; }
        public TimeOnly? StartTime { get; set; }
        public TimeOnly? EndTime { get; set; }
        public string? Reason { get; set; }
    }
}